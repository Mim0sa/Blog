# [è¯‘] Swift | å†…å­˜å®‰å…¨

ä¸€èˆ¬æ¥è¯´ï¼ŒSwift ä¼šé˜»æ­¢ä»£ç ä¸­çš„ä¸å®‰å…¨è¡Œä¸ºã€‚ä¾‹å¦‚ï¼ŒSwift ä¼šä¿è¯å˜é‡åœ¨è¢«ä½¿ç”¨å‰å·²ç»åˆå§‹åŒ–ï¼Œåœ¨é‡Šæ”¾æŸå˜é‡åå…¶å†…å­˜ä¹Ÿä¼šå˜å¾—ä¸å¯è®¿é—®ï¼Œä»¥åŠæ£€æŸ¥æ•°ç»„ç´¢å¼•æ˜¯å¦å­˜åœ¨è¶Šç•Œé”™è¯¯ã€‚

Swift è¿˜é€šè¿‡è¦æ±‚ä¿®æ”¹å†…å­˜ä¸­ä½ç½®çš„ä»£ç å…·æœ‰å¯¹è¯¥å†…å­˜çš„ç‹¬å è®¿é—®æƒï¼Œæ¥ç¡®ä¿å¯¹åŒä¸€å†…å­˜åŒºåŸŸçš„å¤šé‡è®¿é—®ä¸ä¼šäº§ç”Ÿå†²çªã€‚ç”±äº Swift ä¼šè‡ªåŠ¨ç®¡ç†å†…å­˜ï¼Œå› æ­¤å¤§å¤šæ•°æ—¶å€™ä½ æ ¹æœ¬ä¸éœ€è¦è€ƒè™‘å†…å­˜è®¿é—®çš„é—®é¢˜ã€‚ç„¶è€Œï¼Œäº†è§£ä»€ä¹ˆåœ°æ–¹ä¼šæœ‰æ½œåœ¨çš„å†…å­˜å†²çªå‘ç”Ÿä¹Ÿæ˜¯å¾ˆé‡è¦çš„ï¼Œè¿™æ ·ä½ å°±å¯ä»¥é¿å…å†™å‡ºå¯¹å†…å­˜è®¿é—®æœ‰å†²çªçš„ä»£ç ã€‚å¦‚æœä½ çš„ä»£ç ä¸­ç¡®å®åŒ…å«å†²çªï¼Œåˆ™ä¼šå‡ºç°ç¼–è¯‘æ—¶é”™è¯¯æˆ–è¿è¡Œæ—¶é”™è¯¯ã€‚

> è¯‘è‡ª [Swift å®˜æ–¹æ–‡æ¡£](https://docs.swift.org/swift-book/LanguageGuide/MemorySafety.html)ï¼Œæ˜¯ä» [è€å¸æœºå‘¨æŠ¥ #130](https://juejin.im/post/6877746452706099214) ä¸­çœ‹åˆ°çš„è¿™ä¸€ç¯‡ï¼Œç€å®è§£ç­”äº†æˆ‘çš„ä¸€äº›ç–‘æƒ‘ğŸ¯ã€‚

## ç†è§£å…³äºå†…å­˜çš„è®¿é—®å†²çª

å½“ä½ æ‰§è¡Œè®¾ç½®å˜é‡çš„å€¼ã€å°†å‚æ•°ä¼ é€’ç»™å‡½æ•°ä¹‹ç±»çš„ä»£ç æ—¶ï¼Œè®¿é—®å†…å­˜è¿™ä»¶äº‹æƒ…ä¼šå°±å‘ç”Ÿã€‚ä¸¾ä¸ªä¾‹å­ï¼Œä»¥ä¸‹ä»£ç åŒ…å«äº†ä¸€ä¸ªè¯»å–æ“ä½œå’Œä¸€ä¸ªè®¿é—®æ“ä½œï¼š

```swift
// A write access to the memory where one is stored.
var one = 1

// A read access from the memory where one is stored.
print("We're number \(one)!")
```

å½“ä¸åŒéƒ¨åˆ†çš„ä»£ç è¯•å›¾åŒæ—¶è®¿é—®åŒä¸€å—å†…å­˜æ—¶ï¼Œå¯èƒ½ä¼šå‘ç”Ÿå†…å­˜å†²çªè®¿é—®ã€‚ åŒæ—¶è®¿é—®åŒä¸€å—å†…å­˜å¯èƒ½ä¼šå¯¼è‡´ä¸å¯é¢„æµ‹æˆ–ä¸ä¸€è‡´çš„è¡Œä¸ºã€‚ åœ¨ Swift ä¸­ï¼Œæœ‰å¤šç§æ–¹æ³•å¯ä»¥å®ç°åœ¨è·¨è¶Šå¥½å‡ è¡Œä»£ç çš„è¿‡ç¨‹ä¸‹ä¿®æ”¹æŸä¸ªå€¼ï¼Œè¿™å¯¼è‡´å¯ä»¥å®ç°åœ¨ä¿®æ”¹è‡ªèº«çš„è¿‡ç¨‹ä¸­å»å°è¯•è®¿é—®è‡ªå·±çš„å€¼ã€‚

ç°åœ¨é€šè¿‡ä¸€ä¸ªç›¸ä¼¼çš„é—®é¢˜æ¥æ›´å¥½åœ°å¸®åŠ©ä½ ç†è§£è¿™ç§å†²çªï¼Œä¾‹å¦‚ä½ ç°åœ¨è¦åœ¨ä¸€å¼ çº¸ä¸Šæ›´æ–°ä½ çš„è´­ç‰©é¢„ç®—æ¸…å•ã€‚æ›´æ–°è¿™å¼ é¢„ç®—æ¸…å•åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š1.ä½ éœ€è¦æ·»åŠ å•†å“çš„åç§°å’Œä»·æ ¼ï¼Œ2.ä½ éœ€è¦æ›´æ”¹æ€»ä»·æ¥åŒ¹é…ä½ æ›´æ–°åçš„è´¦å•ã€‚åœ¨è¿™ä¸ªæ›´æ–°æ­¥éª¤çš„å‰åï¼Œä½ éƒ½å¯ä»¥ä»è´¦å•ä¸­æ­£ç¡®çš„è¯»å–ä»»ä½•æ•°æ®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![memory_shopping](resources/memory_shopping.png)

å½“ä½ å¾€æ¸…å•ä¸­æ·»åŠ å•†å“æ—¶ï¼Œæ¸…å•å¤„äºä¸€ä¸ªä¸´æ—¶çš„ã€æ— æ•ˆçš„çŠ¶æ€ï¼Œå› ä¸ºè¿™æ—¶æ€»ä»·è¿˜æ²¡æœ‰è¢«æ›´æ–°ã€è¿˜ä¸èƒ½åæ˜ é‚£äº›æ–°åŠ çš„å•†å“ã€‚æ‰€ä»¥å½“ä½ åœ¨æ·»åŠ å•†å“çš„è¿‡ç¨‹ä¸­ï¼Œè¯»å–æ€»ä»·æ ¼çš„è¯ï¼Œä¼šç»™ä½ ä¸€ä¸ªé”™è¯¯çš„ç­”æ¡ˆã€‚

è¿™ä¸ªä¾‹å­åŒæ ·ä¹Ÿå±•ç¤ºäº†åœ¨è§£å†³å†²çªè®¿é—®æ—¶ä½ å¯èƒ½ä¼šé‡åˆ°çš„é—®é¢˜ï¼šä¸ä¸€æ ·è§£å†³å†²çªæ–¹å¼ä¼šå¸¦æ¥ä¸ä¸€æ ·çš„ç­”æ¡ˆï¼Œè¦çŸ¥é“å“ªä¸ªç­”æ¡ˆæ˜¯æ­£ç¡®çš„é€šå¸¸æ¥è¯´æ²¡æœ‰é‚£ä¹ˆæ˜¾è€Œæ˜“è§ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä¸»è¦çœ‹ä½ æ˜¯æƒ³è¦åŸæ¥çš„æ€»ä»·æ ¼è¿˜æ˜¯æ›´æ–°åçš„æ€»ä»·æ ¼ï¼Œ$5 å’Œ $320 éƒ½å¯èƒ½æ˜¯æ­£ç¡®ç­”æ¡ˆã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ä½ è§£å†³å†²çªè®¿é—®ä¹‹å‰ï¼Œä½ å¾—å…ˆè¦ææ¸…æ¥šä½ è¦çš„æ˜¯ä»€ä¹ˆã€‚

> æ³¨æ„
>
> å¦‚æœä½ æ˜¯åœ¨ç¼–å†™æœ‰å…³å¹¶å‘æˆ–å¤šçº¿ç¨‹çš„ä»£ç ï¼Œé‚£ä¹ˆå†…å­˜è®¿é—®å†²çªå¯èƒ½æ˜¯ä¸€ä¸ªå¸¸è§çš„é—®é¢˜ã€‚ä½†è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨è¿™è®¨è®ºçš„å†²çªè®¿é—®æ˜¯å¯èƒ½å‘ç”Ÿåœ¨å•çº¿ç¨‹ä¸Šï¼Œå¹¶ä¸”ä¸æ¶‰åŠå¹¶å‘æˆ–å¤šçº¿ç¨‹ä»£ç ã€‚
>
> å¦‚æœä½ åœ¨å•çº¿ç¨‹ä¸­å¯¹å†…å­˜çš„è®¿é—®å­˜åœ¨å†²çªï¼ŒSwift ä¼šç¡®ä¿åœ¨ç¼–è¯‘æ—¶æˆ–è¿è¡Œæ—¶æŠ¥é”™ã€‚å¯¹äºå¤šçº¿ç¨‹ä»£ç ï¼Œè¯·ä½¿ç”¨  Thread Sanitizer æ¥æ£€æµ‹å¤šçº¿ç¨‹çš„å†²çªè®¿é—®ã€‚

## å†²çªè®¿é—®çš„ç‰¹å¾

åœ¨å†²çªè®¿é—®çš„æ—¶å€™ï¼Œæœ‰ä¸‰ä¸ªè®¿é—®çš„ç‰¹å¾å€¼å¾—æ³¨æ„ï¼š1.è¿™ä¸ªè®¿é—®æ“ä½œæ˜¯è¯»è¿˜æ˜¯å†™ï¼Œ2.è®¿é—®çš„æ—¶å¸¸ï¼Œ3.å…·ä½“è®¿é—®çš„ä½ç½®ã€‚å…·ä½“æ¥è¯´ï¼Œå¦‚æœä½ æœ‰ä¸¤ä¸ªæ»¡è¶³äº†ä»¥ä¸‹æ‰€æœ‰æ¡ä»¶çš„è®¿é—®æ“ä½œï¼Œé‚£ä¹ˆä»–ä»¬æ˜¯ä¼šå‘ç”Ÿå†²çªçš„ï¼š

* ä»–ä»¬ä¹‹ä¸­è‡³å°‘ä¸€ä¸ªæ˜¯å†™å…¥æ“ä½œæˆ–éåŸå­ï¼ˆnonatomicï¼‰æ“ä½œã€‚
* ä»–ä»¬è®¿é—®äº†å†…å­˜ä¸­çš„ç›¸åŒä½ç½®ã€‚
* å®ƒä»¬çš„æŒç»­æ—¶é—´æ˜¯æœ‰é‡å çš„ã€‚

é€šå¸¸æ¥è¯´ï¼Œä¸€ä¸ªè¯»å–æ“ä½œå’Œä¸€ä¸ªå†™å…¥æ“ä½œçš„åŒºåˆ«æ˜¯å¾ˆæ˜æ˜¾çš„ï¼šä¸€ä¸ªå†™å…¥æ“ä½œä¼šæ”¹å˜å†…å­˜ä¸­çš„ä½ç½®ï¼Œä½†è¯»å–æ“ä½œä¸ä¼šã€‚å†…å­˜ä¸­çš„ä½ç½®æ˜¯æŒ‡è¦è®¿é—®çš„å†…å®¹ï¼Œä¾‹å¦‚ï¼šå˜é‡ã€å¸¸é‡æˆ–å±æ€§ã€‚å†…å­˜è®¿é—®å¯ä»¥æ˜¯ç¬æ—¶çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯ç»´æŒä¸€æ®µæ—¶é—´çš„ã€‚

å¦‚æœä½ çš„ä¸€ä¸ªæ“ä½œä»…ä½¿ç”¨äº† C åŸå­ï¼ˆatomicï¼‰æ“ä½œï¼Œåˆ™è¯¥æ“ä½œæ˜¯åŸå­æ“ä½œï¼Œå¦åˆ™å°±æ˜¯éåŸå­çš„ã€‚æœ‰å…³è¿™äº›åŠŸèƒ½ï¼Œè¯¦è§ stdatomicï¼ˆ3ï¼‰æ‰‹å†Œé¡µã€‚

å¦‚æœä½ çš„æŸä¸ªæ“ä½œåœ¨å¼€å§‹ä¹‹åå’Œç»“æŸä¹‹å‰éƒ½æ— æ³•è¿è¡Œå…¶ä»–ä»£ç ï¼Œé‚£ä¹ˆè¿™ä¸ªæ“ä½œå°±æ˜¯ä¸€ä¸ªç¬æ—¶æ“ä½œã€‚ä»æœ¬è´¨ä¸Šæ¥è¯´ï¼Œä¸¤ä¸ªç¬æ—¶æ“ä½œæ˜¯ä¸èƒ½åœ¨åŒä¸€æ—¶é—´å‘ç”Ÿçš„ã€‚å¹¶ä¸”ï¼Œå¤§å¤šæ•°å†…å­˜è®¿é—®æ“ä½œéƒ½æ˜¯ç¬æ—¶çš„ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œä»¥ä¸‹ä»£ç ä¸­è¯»å–å’Œå†™å…¥æ“ä½œéƒ½æ˜¯ç¬æ—¶çš„ï¼š

```swift
func oneMore(than number: Int) -> Int {
    return number + 1
}

var myNumber = 1
myNumber = oneMore(than: myNumber)
print(myNumber)
// Prints "2"
```



















